{
  "name": "ğŸ§  Simone - IA Central Doctor Auto",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "simone-webhook",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-entrada",
      "name": "ğŸ”” Webhook Kommo",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [220, 300],
      "webhookId": "simone-doctor-auto"
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://doctorautobosch.kommo.com/api/v4/leads/{{ $json.body.leads.add[0].id || $json.body.leads.update[0].id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {
          "response": {
            "response": {
              "fullResponse": false
            }
          }
        }
      },
      "id": "buscar-lead",
      "name": "ğŸ“¥ Buscar Lead Completo",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [440, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "KOMMO_CREDENTIAL_ID",
          "name": "Kommo API - Doctor Auto"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "table": "simone_config",
        "limit": 1
      },
      "id": "buscar-config",
      "name": "âš™ï¸ Buscar Config Simone",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [440, 500],
      "credentials": {
        "supabaseApi": {
          "id": "SUPABASE_CREDENTIAL_ID",
          "name": "Supabase - Doctor Auto"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "table": "simone_servicos",
        "filters": {
          "conditions": [
            {
              "keyName": "ativo",
              "keyValue": "true"
            }
          ]
        }
      },
      "id": "buscar-servicos",
      "name": "ğŸ› ï¸ Buscar ServiÃ§os",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [440, 700],
      "credentials": {
        "supabaseApi": {
          "id": "SUPABASE_CREDENTIAL_ID",
          "name": "Supabase - Doctor Auto"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "table": "simone_upsell",
        "filters": {
          "conditions": [
            {
              "keyName": "ativo",
              "keyValue": "true"
            }
          ]
        }
      },
      "id": "buscar-upsell",
      "name": "ğŸ’° Buscar Regras Upsell",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [440, 900],
      "credentials": {
        "supabaseApi": {
          "id": "SUPABASE_CREDENTIAL_ID",
          "name": "Supabase - Doctor Auto"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Combinar todos os dados para o contexto da Simone\nconst lead = $('ğŸ“¥ Buscar Lead Completo').first().json;\nconst config = $('âš™ï¸ Buscar Config Simone').first().json;\nconst servicos = $('ğŸ› ï¸ Buscar ServiÃ§os').all().map(i => i.json);\nconst upsellRules = $('ğŸ’° Buscar Regras Upsell').all().map(i => i.json);\n\n// Extrair dados do lead\nconst leadId = lead.id;\nconst leadNome = lead.name || 'Cliente';\nconst etapaId = lead.status_id;\nconst pipelineId = lead.pipeline_id;\nconst customFields = lead.custom_fields_values || [];\n\n// Mapear etapas\nconst etapas = {\n  98157076: 'QUALIFICAÃ‡ÃƒO',\n  98157080: 'ATENDIMENTO',\n  98157088: 'ORÃ‡AMENTO',\n  98157084: 'TENTANDO AGENDAR',\n  98157456: 'POTENCIAL CLIENTE',\n  98157516: 'FOLLOW UP',\n  98157520: 'AGENDADO',\n  98157580: 'ENTREGUE',\n  142: 'FECHADO GANHO',\n  143: 'FECHADO PERDIDO'\n};\n\nconst etapaAtual = etapas[etapaId] || 'DESCONHECIDA';\n\n// Calcular tempo parado (em minutos)\nconst updatedAt = new Date(lead.updated_at * 1000);\nconst agora = new Date();\nconst tempoParado = Math.floor((agora - updatedAt) / 60000);\n\n// Extrair serviÃ§o do campo personalizado\nlet servicoSolicitado = '';\nconst campoServico = customFields.find(f => f.field_id === 966171);\nif (campoServico && campoServico.values) {\n  servicoSolicitado = campoServico.values[0]?.value || '';\n}\n\n// Determinar aÃ§Ã£o baseada na etapa e tempo\nlet acaoNecessaria = 'analisar';\nlet urgencia = 'normal';\n\nif (etapaAtual === 'QUALIFICAÃ‡ÃƒO' && tempoParado > config.tempo_alerta_qualificacao) {\n  acaoNecessaria = 'classificar_e_alertar';\n  urgencia = 'alta';\n} else if (etapaAtual === 'ATENDIMENTO' && tempoParado > config.tempo_alerta_atendimento) {\n  acaoNecessaria = 'alertar_urgente';\n  urgencia = 'urgente';\n} else if (etapaAtual === 'FOLLOW UP' && tempoParado > config.tempo_alerta_followup) {\n  acaoNecessaria = 'reativar';\n  urgencia = 'media';\n} else if (etapaAtual === 'QUALIFICAÃ‡ÃƒO') {\n  acaoNecessaria = 'classificar';\n} else if (etapaAtual === 'ATENDIMENTO') {\n  acaoNecessaria = 'vender';\n} else if (etapaAtual === 'ORÃ‡AMENTO') {\n  acaoNecessaria = 'acompanhar_orcamento';\n}\n\nreturn {\n  lead: {\n    id: leadId,\n    nome: leadNome,\n    etapa: etapaAtual,\n    etapa_id: etapaId,\n    tempo_parado: tempoParado,\n    servico_solicitado: servicoSolicitado,\n    dados_completos: lead\n  },\n  config: config,\n  servicos: servicos,\n  upsell_rules: upsellRules,\n  acao: acaoNecessaria,\n  urgencia: urgencia\n};"
      },
      "id": "preparar-contexto",
      "name": "ğŸ”§ Preparar Contexto",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [700, 500]
    },
    {
      "parameters": {
        "model": "deepseek-chat",
        "messages": {
          "values": [
            {
              "role": "system",
              "content": "={{ $json.config.prompt_sistema }}\n\n## SERVIÃ‡OS DISPONÃVEIS:\n{{ JSON.stringify($json.servicos, null, 2) }}\n\n## REGRAS DE UPSELL:\n{{ JSON.stringify($json.upsell_rules, null, 2) }}"
            },
            {
              "role": "user",
              "content": "=LEAD: {{ $json.lead.nome }}\nETAPA ATUAL: {{ $json.lead.etapa }}\nTEMPO PARADO: {{ $json.lead.tempo_parado }} minutos\nSERVIÃ‡O SOLICITADO: {{ $json.lead.servico_solicitado || 'NÃ£o informado' }}\n\nAÃ‡ÃƒO NECESSÃRIA: {{ $json.acao }}\nURGÃŠNCIA: {{ $json.urgencia }}\n\nAnalise este lead e retorne um JSON com:\n{\n  \"classificacao\": \"quente|morno|frio\",\n  \"score\": 0-100,\n  \"analise\": \"sua anÃ¡lise do lead\",\n  \"acao_sugerida\": \"o que fazer agora\",\n  \"resposta_sugerida\": \"mensagem para enviar ao cliente (se aplicÃ¡vel)\",\n  \"upsell_sugerido\": \"serviÃ§o extra para oferecer (se aplicÃ¡vel)\",\n  \"mover_para_etapa\": \"nome da etapa (se deve mover)\",\n  \"gerar_alerta\": true|false,\n  \"mensagem_alerta\": \"mensagem para o consultor (se gerar_alerta)\"\n}"
            }
          ]
        },
        "options": {
          "baseURL": "https://api.deepseek.com/v1",
          "maxTokens": 1000,
          "temperature": 0.7
        }
      },
      "id": "deepseek-analise",
      "name": "ğŸ¤– DeepSeek - AnÃ¡lise",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [940, 500],
      "credentials": {
        "openAiApi": {
          "id": "DEEPSEEK_CREDENTIAL_ID",
          "name": "DeepSeek API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parsear resposta da IA\nconst input = $input.first().json;\nlet resposta;\n\ntry {\n  // Tentar extrair JSON da resposta\n  const content = input.message?.content || input.text || '';\n  const jsonMatch = content.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    resposta = JSON.parse(jsonMatch[0]);\n  } else {\n    resposta = {\n      classificacao: 'morno',\n      score: 50,\n      analise: content,\n      acao_sugerida: 'Verificar manualmente',\n      gerar_alerta: true,\n      mensagem_alerta: 'IA nÃ£o conseguiu analisar completamente'\n    };\n  }\n} catch (e) {\n  resposta = {\n    classificacao: 'morno',\n    score: 50,\n    analise: 'Erro ao processar resposta da IA',\n    acao_sugerida: 'Verificar manualmente',\n    gerar_alerta: true,\n    mensagem_alerta: 'Erro no processamento: ' + e.message\n  };\n}\n\nreturn {\n  ...resposta,\n  lead_id: $('ğŸ”§ Preparar Contexto').first().json.lead.id,\n  lead_nome: $('ğŸ”§ Preparar Contexto').first().json.lead.nome,\n  etapa_atual: $('ğŸ”§ Preparar Contexto').first().json.lead.etapa\n};"
      },
      "id": "processar-resposta",
      "name": "ğŸ“Š Processar Resposta IA",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1180, 500]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.gerar_alerta }}",
              "value2": true
            }
          ]
        }
      },
      "id": "verificar-alerta",
      "name": "ğŸš¨ Gerar Alerta?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1420, 500]
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "simone_alertas",
        "columns": "lead_id,lead_nome,tipo_alerta,mensagem,etapa",
        "data": "={{ $json.lead_id }},{{ $json.lead_nome }},urgente,{{ $json.mensagem_alerta }},{{ $json.etapa_atual }}"
      },
      "id": "salvar-alerta",
      "name": "ğŸ’¾ Salvar Alerta",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1700, 400],
      "credentials": {
        "supabaseApi": {
          "id": "SUPABASE_CREDENTIAL_ID",
          "name": "Supabase - Doctor Auto"
        }
      }
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "simone_historico",
        "columns": "lead_id,lead_nome,acao,etapa_origem,score_calculado,classificacao,resposta_ia",
        "data": "={{ $json.lead_id }},={{ $json.lead_nome }},analise,={{ $json.etapa_atual }},={{ $json.score }},={{ $json.classificacao }},={{ $json.analise }}"
      },
      "id": "salvar-historico",
      "name": "ğŸ“ Salvar HistÃ³rico",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1420, 700],
      "credentials": {
        "supabaseApi": {
          "id": "SUPABASE_CREDENTIAL_ID",
          "name": "Supabase - Doctor Auto"
        }
      }
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "=https://doctorautobosch.kommo.com/api/v4/leads/{{ $json.lead_id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "custom_fields_values",
              "value": "=[{\"field_id\": 966171, \"values\": [{\"value\": \"Score: {{ $json.score }} | {{ $json.classificacao }}\"}]}]"
            }
          ]
        },
        "options": {}
      },
      "id": "atualizar-kommo",
      "name": "âœï¸ Atualizar Lead Kommo",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1700, 700],
      "credentials": {
        "httpHeaderAuth": {
          "id": "KOMMO_CREDENTIAL_ID",
          "name": "Kommo API - Doctor Auto"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={\"success\": true, \"lead_id\": \"{{ $('ğŸ“Š Processar Resposta IA').first().json.lead_id }}\", \"classificacao\": \"{{ $('ğŸ“Š Processar Resposta IA').first().json.classificacao }}\", \"score\": {{ $('ğŸ“Š Processar Resposta IA').first().json.score }}}"
      },
      "id": "resposta-webhook",
      "name": "âœ… Resposta Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1940, 500]
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 15
            }
          ]
        }
      },
      "id": "cron-verificacao",
      "name": "â° VerificaÃ§Ã£o PeriÃ³dica",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [220, 100]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://doctorautobosch.kommo.com/api/v4/leads",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "filter[statuses][0][pipeline_id]",
              "value": "12717900"
            },
            {
              "name": "filter[statuses][0][status_id]",
              "value": "98157076"
            },
            {
              "name": "filter[statuses][1][status_id]",
              "value": "98157080"
            },
            {
              "name": "filter[statuses][2][status_id]",
              "value": "98157516"
            },
            {
              "name": "limit",
              "value": "50"
            }
          ]
        },
        "options": {}
      },
      "id": "buscar-leads-parados",
      "name": "ğŸ“¥ Buscar Leads Ativos",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [440, 100],
      "credentials": {
        "httpHeaderAuth": {
          "id": "KOMMO_CREDENTIAL_ID",
          "name": "Kommo API - Doctor Auto"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Filtrar leads parados por muito tempo\nconst leads = $input.first().json._embedded?.leads || [];\nconst agora = Date.now();\nconst alertas = [];\n\nconst limites = {\n  98157076: 30,  // QUALIFICAÃ‡ÃƒO: 30 min\n  98157080: 120, // ATENDIMENTO: 2h\n  98157516: 2880 // FOLLOW UP: 48h\n};\n\nconst etapas = {\n  98157076: 'QUALIFICAÃ‡ÃƒO',\n  98157080: 'ATENDIMENTO',\n  98157516: 'FOLLOW UP'\n};\n\nfor (const lead of leads) {\n  const updatedAt = lead.updated_at * 1000;\n  const tempoParado = Math.floor((agora - updatedAt) / 60000);\n  const limite = limites[lead.status_id];\n  \n  if (limite && tempoParado > limite) {\n    alertas.push({\n      lead_id: lead.id,\n      lead_nome: lead.name,\n      etapa: etapas[lead.status_id],\n      tempo_parado: tempoParado,\n      urgencia: tempoParado > limite * 2 ? 'urgente' : 'alta'\n    });\n  }\n}\n\nreturn alertas.length > 0 ? alertas : [{ sem_alertas: true }];"
      },
      "id": "filtrar-parados",
      "name": "ğŸ” Filtrar Leads Parados",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [700, 100]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.sem_alertas }}",
              "value2": true
            }
          ]
        }
      },
      "id": "tem-alertas",
      "name": "â“ Tem Alertas?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [940, 100]
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "simone_alertas",
        "columns": "lead_id,lead_nome,tipo_alerta,mensagem,etapa,tempo_parado",
        "data": "={{ $json.lead_id }},={{ $json.lead_nome }},urgente,Lead parado hÃ¡ {{ $json.tempo_parado }} minutos,={{ $json.etapa }},={{ $json.tempo_parado }}"
      },
      "id": "criar-alertas-batch",
      "name": "ğŸš¨ Criar Alertas",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1180, 50],
      "credentials": {
        "supabaseApi": {
          "id": "SUPABASE_CREDENTIAL_ID",
          "name": "Supabase - Doctor Auto"
        }
      }
    }
  ],
  "connections": {
    "ğŸ”” Webhook Kommo": {
      "main": [
        [
          {
            "node": "ğŸ“¥ Buscar Lead Completo",
            "type": "main",
            "index": 0
          },
          {
            "node": "âš™ï¸ Buscar Config Simone",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ› ï¸ Buscar ServiÃ§os",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ’° Buscar Regras Upsell",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¥ Buscar Lead Completo": {
      "main": [
        [
          {
            "node": "ğŸ”§ Preparar Contexto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âš™ï¸ Buscar Config Simone": {
      "main": [
        [
          {
            "node": "ğŸ”§ Preparar Contexto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ› ï¸ Buscar ServiÃ§os": {
      "main": [
        [
          {
            "node": "ğŸ”§ Preparar Contexto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’° Buscar Regras Upsell": {
      "main": [
        [
          {
            "node": "ğŸ”§ Preparar Contexto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”§ Preparar Contexto": {
      "main": [
        [
          {
            "node": "ğŸ¤– DeepSeek - AnÃ¡lise",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ¤– DeepSeek - AnÃ¡lise": {
      "main": [
        [
          {
            "node": "ğŸ“Š Processar Resposta IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š Processar Resposta IA": {
      "main": [
        [
          {
            "node": "ğŸš¨ Gerar Alerta?",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ“ Salvar HistÃ³rico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸš¨ Gerar Alerta?": {
      "main": [
        [
          {
            "node": "ğŸ’¾ Salvar Alerta",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "âœï¸ Atualizar Lead Kommo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’¾ Salvar Alerta": {
      "main": [
        [
          {
            "node": "âœï¸ Atualizar Lead Kommo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ Salvar HistÃ³rico": {
      "main": [
        [
          {
            "node": "âœï¸ Atualizar Lead Kommo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âœï¸ Atualizar Lead Kommo": {
      "main": [
        [
          {
            "node": "âœ… Resposta Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â° VerificaÃ§Ã£o PeriÃ³dica": {
      "main": [
        [
          {
            "node": "ğŸ“¥ Buscar Leads Ativos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¥ Buscar Leads Ativos": {
      "main": [
        [
          {
            "node": "ğŸ” Filtrar Leads Parados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” Filtrar Leads Parados": {
      "main": [
        [
          {
            "node": "â“ Tem Alertas?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â“ Tem Alertas?": {
      "main": [
        [],
        [
          {
            "node": "ğŸš¨ Criar Alertas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "name": "Doctor Auto",
      "createdAt": "2026-01-26T00:00:00.000Z",
      "updatedAt": "2026-01-26T00:00:00.000Z"
    },
    {
      "name": "IA Central",
      "createdAt": "2026-01-26T00:00:00.000Z",
      "updatedAt": "2026-01-26T00:00:00.000Z"
    }
  ],
  "triggerCount": 2,
  "updatedAt": "2026-01-26T00:00:00.000Z",
  "versionId": "simone-v1"
}
